---
layout: article
title: Optimize DNS
aside:
  toc: true
tags: dns
key: dns
comments: true
---

Try to optimize your dns server on LAN and avoid some unsafe issue.

<!--more-->

# Outline

- Use unbound as main dns server. ( eg: port53 )
- Use smartdns as internel dns request. ( eg: port531 )
- Use clash as transperent proxy and externel dns request. ( eg: port532 )
- Use dnsmasq-china-list to identify internel/externel domains.

# Unbound

## Main configure

{% highlight shell %}
server:
    verbosity: 1
    num-threads: 2
    interface: 0.0.0.0@53
    do-ip4: yes
    do-udp: yes
    do-not-query-localhost: no
    access-control: 192.168.0.0/16 allow # set as your own ip address
    include: "/etc/unbound.conf.d/accelerated-domains.china.unbound.conf"
    forward-zone:
        name: "."
        forward-addr: 127.0.0.1@532
{% endhighlight %}

## Other configure

{% highlight shell %}
cache-min-ttl: 3600
cache-max-ttl: 86400 # min and max cache time, set as you like
module-config: "iterator" # remove validation to disable DNSSEC check
{% endhighlight %}

# smartdns

Install smartdns and fill up some dns server in the configure file. Just use some fast 'formal' DNS servers because we only use smartdns on internel dns request based on a list file. If a domain is not in the list, then it will not be passed to smartdns.

# clash

Do not write any un-trusted DNS in configure file. Only use externel servers.

# dnsmasq-china-list

- Get the project:
{% highlight shell %}
git clone https://github.com/felixonmars/dnsmasq-china-list.git --depth 1
cd dnsmasq-china-list
make SERVER=127.0.0.1@531 unbound
{% endhighlight %}

- Copy the file to unbound dir:
{% highlight shell %}
cp accelerated-domains.china.unbound.conf /etc/unbound.conf.d/
{% endhighlight %}

# Others

Use `dig` to check:
{% highlight shell %}
dig @dns-server domain -p port
{% endhighlight %}


# REF

- [https://a-wing.top/network/2020/03/01/bypass_gateway-2_improve_dns.html](https://a-wing.top/network/2020/03/01/bypass_gateway-2_improve_dns.html)
